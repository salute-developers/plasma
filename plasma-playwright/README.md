# Библиотека для тестирования компонентов Plasma

В данном пакете содержится экспорт двух методов из _Playwright_, для использования внутри `package/*`. В корень директории `plasma` установить playwright невозможно на данном этапе, так как происходит конфликт версии _vite_, с той, которая устанавливается через _storybook_.

Так же в директории _utils_ находится пакет _plasma-playwright-utils_ с утилитами для удобства тестирования.

## Установка зависимостей

Для запуска тестов локально необходимо выполнить bootstrap со scope из корня:

```
npx lerna bootstrap --scope={@salutejs/plasma-b2c,@salutejs/plasma-web,@salutejs/sdds-cs,@salutejs/sdds-insol,@salutejs/plasma-playwright,@salutejs/plasma-playwright-utils}
```

Если нет слинковынных тем из _plasma-themes_ и _sdds-themes_ нужно добавить их в scope

## Организация тестов

Тесты необходимо создавать по следующим принципам:

-   основной файл с тестами имеет суффикс `.spec.tsx` (определяется параметром _testMatch_ в _playwright-ct.config.ts_)
-   обязательно должен присутствовать файл `component.export.ts` с экспортом компонентов, необходимых для тестирования
    > **Warning**  
    > Без наличия экспорта компонентов из данного файла в файл с тестами, невозможно корректно разрешить путь к файлу билда тестируемого компонента

> **Note**  
> Пришлось отказаться от функционала getComponent, реализованного в рамках тестирования с помощью _cypress_. Так как там использовался контекст _Node.js_; _playwright_ запускает тесты в контексте браузера.

-   данные два файла можно положить в директорию _test_
-   внутри файла с тестами `.spec.tsx` нельзя создавать другие компоненты, например:

#### **`div.spec.tsx`**

```tsx
const StyledDiv = styled.div``;

test('test div', async ({ mount }) => {
    ...
    const locator = await mount(
        <>
            <p>some info</p>
            <StyledDiv>some extra info</StyledDiv>
        </>
    )
    ...
})
```

такой тест упадет с ошибкой, указывающей на mount.

-   для создания дополнительных оберток или же дополнительной стилизации теста, создаем отдельный файл

## Запус тестов

Под каждый пакет доступный для тестирования есть своя команда запуска. Например для тестирования plasma-b2c:

```json
"test:b2c": "PACKAGE=plasma-b2c playwright test -c playwright-ct.config.ts --project=plasma-b2c"
```

В рутовом _package.json_ эта команда выглядит так:

```json
"test:b2c": "npm run test:b2c --prefix=plasma-playwright"
```

_prefix_ передает директорию, где надо выполнить команду.

## Запус тестов для конкретных компонентов

Для запуска тестов под определенные компоненты необходимо передать аргумент `--components` и в нем перечислить через запятую нужные компоненты:

```
npm run test:b2c --components="Button,Accordion"
```

Такая передача аргумента актуаьная как для запуска тестов из директории _plasma-playwright_, так и из рутовой директории.

## Обновление снапшотов

Для обновления снапшотов неообходимо запустить команду с флагом `--update-snapshots`, с учетом контекста. То есть, если команда выполняется из директории _plasma-playwright_, команда будет выглядеть так:

```
npm run test:b2c -- --update-snapshots
```

Если же команда запускается из **рутовой** директории, то необходимо передать два раза `--`:

```
npm run test:b2c -- -- --update-snapshots
```

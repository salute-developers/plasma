# Библиотека для тестирования компонентов Plasma

В данном пакете содержится экспорт двух методов из _Playwright_, для использования внутри `package/*`. В корень директории `plasma` установить playwright невозможно на данном этапе, так как происходит конфликт версии _vite_, с той, которая устанавливается через _storybook_.

## Установка зависимостей

Для запуска тестов локально необходимо выполнить bootstrap со scope из корня:

```
npx lerna bootstrap --scope={@salutejs/plasma-b2c,@salutejs/plasma-web,@salutejs/sdds-cs,@salutejs/sdds-insol,@salutejs/plasma-playwright}
```

Если нет слинковынных тем из _plasma-themes_ и _sdds-themes_ нужно добавить их в scope

## Организация тестов

Тесты необходимо создавать по следующим принципам:

-   основной файл с тестами имеет суффикс `.spec.tsx` (определяется параметром _testMatch_ в _playwright-ct.config.ts_)
-   обязательно должен присутствовать файл `component.export.ts` с экспортом компонентов, необходимых для тестирования

    > **Warning**  
    > Без наличия экспорта компонентов из данного файла в файл с тестами, невозможно корректно разрешить путь к файлу билда тестируемого компонента

-   данные два файла можно положить в директорию _test_
-   внутри файла с тестами `.spec.tsx` нельзя создавать другие компоненты, например:

#### **`div.spec.tsx`**

```tsx
const StyledDiv = styled.div``;

test('test div', async ({ mount }) => {
    ...
    const locator = await mount(
        <>
            <p>some info</p>
            <StyledDiv>some extra info</StyledDiv>
        </>
    )
    ...
})
```

такой тест упадет с ошибкой, указывающей на mount.

-   для создания дополнительных оберток или же дополнительной стилизации теста, создаем отдельный файл
-   тесты связанные с проверкой логики компонента, или же тесты, у которых будут одинаковые наборы снапшотов, следует помещать внутрь _plasma-new-hope_ рядом с ядром компонента; в файле component.export.ts копмонент импортируется из директории с примерами `examples`

## Запус тестов

Под каждый пакет доступный для тестирования есть своя команда запуска. Например для тестирования plasma-b2c:

```json
"test:b2c": "PACKAGE=plasma-b2c COMPONENTS=$npm_config_components BUILD_VARIANT=$npm_config_build playwright test -c playwright-ct.config.ts --project=plasma-b2c $(npm run check-has-update --silent)"
```

Где

-   `PACKAGE` - перемнная для корректного резолва директории, в которой находятся тесты
-   `COMPONENTS` - переменная набора компонент, по которым нужно запустить тесты
-   `BUILD_VARIANT` - вариант сборки, на которой нужно прогнать тесты
-   `$(npm run check-has-update --silent)` - допольнительная команда для проверки передачи флага обновления снапшотов

В рутовом _package.json_ эта команда выглядит так:

```json
"test:b2c": "npm run test:b2c --prefix=plasma-playwright"
```

Соответственно, доступные флаги (примеры):

-   `--components="Accordion,Button"`
-   `--build=css`
-   `--update-snapshots`

_prefix_ передает директорию, где надо выполнить команду.

## Запус тестов для конкретных компонентов

Для запуска тестов под определенные компоненты необходимо передать аргумент `--components` и в нем перечислить через запятую нужные компоненты:

```
npm run test:b2c --components="Button,Accordion"
```

Такая передача аргумента актуаьная как для запуска тестов из директории _plasma-playwright_, так и из рутовой директории.

## Обновление снапшотов

Для обновления снапшотов необходимо запустить команду с флагом `--update-snapshots`:

```
npm run test:b2c --update-snapshots
```

## Запуск тестов для определенной сборки

По умолчанию тестирование запускается на компонентах, собранных с помощью _styled-components_. С помощью фалага `--build` можно задать сборку: либо _css_ (для _plasma-{b2c,web}_), либо _emotion_ (для _sdds-{insol,cs}_)

> **Warning**  
> Запуск тестов для emotion пока недоступен из-за проблем со сборками тем. Происходит конфликт cjs и esm форматов. Будет исправлено в следующей итерации.

# Contributing

Процесс внесения изменений в репозиторий

## Commit step

Мы используем Conventional Commits (<https://www.conventionalcommits.org/>). Git commit message должен быть на английском языке.
Изменения в коммите должны затрагивать только один пакет.
Версионирование пакетов происходит автоматически, руками версию в `package.json` не поднимаем.

Пример коммита в пакет `@salutejs/plasma-ui`:

```sh
git commit -m "feat(plasma-ui): Component X added"
```

Пример 2:

```sh
git commit -m "fix(plasma-web): Fix component Y"
```

Использование Conventional Commits обязательно:

-   `fix` - если вносится исправление в существующую функциональность. Приведет к выпуску _патча_ пакета по [semver](https://semver.org/lang/ru/);
-   `feat` - если в кодовую базу добавляется новая функциональность. Приведет к выпуску _минорной_ версии пакета;
-   `docs` - если вносится изменение в контент документации, например в файлах с расширениями `*.md` и `*.mdx`;
-   `chore` - если вносимые изменения не относятся ни к кодовой базе пакетов, ни к документации;
-   `build` - сборка пакетов и утилит;
-   `ci` - для всех коммитов в папке .github

## Node, npm versions

Для корректной работы, необходимо использовать `node` версии `v14.x`, а также `npm` версии `6.x`. Или же воспользоваться командой `nvm use` в корне репозитория.

## Разработка с помощью Lerna

Для внесения правок в нескольких пакетах одновременно, необходимо выполнение команды `npx lerna bootstrap` или `npx lerna bootstrap --scope [имя пакета 1] --scope [имя пакета 2]`. Первый способ [установит зависимости и слинкует](https://github.com/lerna/lerna/blob/main/commands/bootstrap/README.md) все пакеты, а второй - только указанные.

## Pull request

-   Создаем PR в ветку `master`, дожидаемся успешного завершения работы ci. Если последний commit-message содержит `[skip ci]` - ci запущен не будет.
-   По завершению должны выпуститься canary-версии затронутых пакетов.
-   Дожидаемся аппрува от всех ревьюеров ПРа.
-   Мержим ПР.

После успешного завешения работы ci для каждого затронутого пакета будет:

-   Поднята версия
-   Собран `CHANGELOG.md` (+ общий для всего монорепозитория)
-   Выпущена новая версия в npm-registry
-   Получен положительный результат после проведения тестов
-   Собрана документация и Storybook по адресу (<https://bit.ly/36MIrA0>)

## Тесты

### Запуск тестов со скриншотами

Для запуска тестов со скриншотами с помощью Cypress необходим Docker.

На примере пакета `@salutejs/plasma-ui` прогон тестов выглядит следующим образом:

-   если Docker не установлен, установите его;
-   убедитесь, что докер запущен;
-   необходимо установить все пакеты в монорепозитории, для этого в корне монорепозитория выполните команды `npm ci`, а потом `npx lerna bootstrap`;
-   запустите прогон тестов, в корне монорепозитория выполните команду `npm run cy:ui:run-ct` (для остальных пакетов команды будут соответствующими);
-   обновите скриншоты, если это необходимо, для этого выполните `npm run cy:ui:run-ct-update-diffs`;
-   для отладки тестов, используйте команду `npm run cy:ui:open-ct`

### Тестирование производительности в Storybook

Это тестирование зависит от мощности устройства, на котором оно производится. Исходные результаты были получены на MacBook Pro (15-inch, 2019) с Core i7 и MacBook Pro (16-inch, 2019) с Core i9.

Компоненты, которые необходимо проверять на деградацию производительности во время ревью:

-   Picker, Carousel, Tabs, ProductCard, Stepper.

Проверку можно провести локально или с помощью артефактов из Pull Request в GitHub.

На примере Pull Request в GitHub проверка выглядит следующим образом:

-   вы что-то изменили в одном из перечисленных выше компонентов;
-   открываете PR и ждёте сборки артефактов;
-   открываете <http://plasma.sberdevices.ru/pr-номер_вашего_PR/ui-storybook/>
-   открываете Story изменённого вами компонента и переходите на вкладку Performance;
-   нажимаете кнопку Load Results и загружаете json с соответствующим названием, лежащий в одной директории с Story или директории `performance-results`;
-   результаты тестирования автоматически закрепятся;
-   вы можете запустить тестирование кнопкой `Start All`, проверка займёт какое-то время;
-   после тестирования убедитесь, что ваш результат не хуже исходного более, чем на 20%;
-   если деградация вызвана объективными причинами и не может быть устранена, необходимо сгенерировать новый json с результатами и добавить в коммит описание причин деградации.

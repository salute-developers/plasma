name: Change detection

on:
  workflow_call:
    outputs:
      CHANGE_DETECTION_STATE:
        description: "CHANGE_DETECTION_STATE"
        value: ${{ jobs.run.outputs.STATE }}
jobs:
  run:
    runs-on: ubuntu-latest
    outputs:
      STATE: ${{ steps.set-state.outputs.STATE }}

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Prepare environment
        uses: ./.github/actions/prepare-environment

      - name: Get lerna ls output
        shell: bash
        id: changed-state
        # `tr '\n' ','` -> replace \n to ','
        # `sed 's/,$//` -> delete last ',' character
        run: echo "CHANGED_STATE=$(npx lerna ls --all --since=$(git merge-base --fork-point origin/dev) | tr '\n' ',' | sed 's/,$//' | sed 's/(PRIVATE)/''/g' |  sed 's/[ \t]/''/g')" >> "$GITHUB_OUTPUT"

      - name: Computed scope state
        id: scope
        uses: actions/github-script@v6
        env:
          CHANGED_STATE: ${{ steps.changed-state.outputs.CHANGED_STATE }}
        with:
          script: |
            const processingScope = require('./.github/processing-scope.js');
            
            return processingScope();

      - name: Set state
        id: set-state
        run: echo "STATE=${{ toJSON(steps.scope.outputs.result) }}" >> $GITHUB_OUTPUT

      - name: Echo state
        run: echo "STATE ---> ${{ toJSON(steps.scope.outputs.result) }}"

